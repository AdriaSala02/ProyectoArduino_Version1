// ESTACIÓN TIERRA
// Python <===> Estación de Tierra

#include <SoftwareSerial.h>

#define LED_PIN     13   // LED de actividad (verde)
#define LED_ERROR    8   // LED rojo de error 
#define BAUDRATE  9600

SoftwareSerial mySerial(10, 11);  // RX, TX con Satélite



void setup() {

  Serial.begin(BAUDRATE);
  mySerial.begin(BAUDRATE);

  pinMode(LED_PIN, OUTPUT);
  pinMode(LED_ERROR, OUTPUT);
  digitalWrite(LED_PIN, LOW);
  digitalWrite(LED_ERROR, LOW);

  Serial.setTimeout(50);
  mySerial.setTimeout(50);

  Serial.println("Estación de tierra lista. Esperando comandos desde Python.");
}

void loop() {

// ================================
  // Satélite <--> Estación tierra
// ================================
  String com ="";    // se declara como nulo para que exista tmb fuera del bucle
  String com_sat = "";
  while (mySerial.available()) {

    // Lee y envia de sat --> Python
    com_sat = mySerial.readStringUntil('|');   // toda la comuniación pasa por "com_sat" para leerse o enviar
    
    if (com_sat.length() > 0) {
    Serial.print(com_sat);
    Serial.print('|'); // se elimina al leer

  
    // aqui es donde pondremos todo lo que tiene que hacer dependiendo de lo que envie el satelite
    // por ejemplo, si envia errores de datos

    }
    if (com_sat.equals("16:1:-1") || com_sat.equals("16:1:-2")) { // error lectura del DHS || error ángulo
        digitalWrite(LED_ERROR, HIGH);
      } else {
        // se apaga si no hay error
        digitalWrite(LED_ERROR, LOW);
      }
    }
  }

// ==================================
  // Estación tierra <--> Python
// ==================================
  while (Serial.available()) {
    com = Serial.readStringUntil('|');
  }

  if (com.length() == 0) {            // Hay Error?
      return;
  }

// =================================================================
  
  //mensajes de texto de python al sat
  if (com.startsWith("16:0")) {
    mySerial.print(com);
    mySerial.print('|');
  }

//SENSOR DE HUMEDAD Y DISTANCIA
  if (com.startsWith("16:1:")) {
    mySerial.print(com);
    mySerial.print('|');

    // Aquí solo van las funciones que modifican algo en tierra
    // El resto se mandan directamente al satélite

    if (com.equals("16:1:1")) {        // INICIO
      digitalWrite(LED_PIN,HIGH);
    }

    else if (com.equals("16:1:2")) {   // 16:1:2| PARAR
      digitalWrite(LED_PIN, LOW);
    }

    else if (com.equals("16:1:3")) {   // 16:1:3| REANUDAR
      digitalWrite(LED_PIN, HIGH);

    }
  }

// =================================================================
// SERVO 

  else if (com.startsWith("16:2:")) {
    mySerial.print(com);
    mySerial.print('|');
  }

// =================================================================
// Distancia??

}
